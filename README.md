# Nginx with Let's Encrypt SSL

A Docker-based nginx web server setup with automatic SSL certificate management using Let's Encrypt and Certbot.

## Prerequisites

- Docker Engine 20.10+
- Docker Compose 2.0+
- A registered domain name with DNS pointing to your server
- Ports 80 and 443 available
- Docker network `docker.local` created (see step 1 below)

## Quick Start

1. Clone this repository:
   ```bash
   git clone <repository-url>
   cd <project-directory>
   ```

2. Create the Docker network:
   ```bash
   docker network create docker.local
   ```

3. Update `nginx/conf/default.conf` with your domain name:
   ```nginx
   server_name yourdomain.com *.yourdomain.com;
   ```

4. Generate initial SSL certificates:
   ```bash
   docker compose run --rm certbot certonly --webroot -w /var/www/certbot -d yourdomain.com -d www.yourdomain.com --agree-tos -m your-email@example.com
   ```

5. Start the services:
   ```bash
   docker compose up -d
   ```

6. Verify the setup:
   ```bash
   curl -I https://yourdomain.com
   ```

## Directory Structure

```
.
├── docker-compose.yml      # Docker services configuration
├── nginx/
│   ├── conf/
│   │   └── default.conf    # Nginx server configuration
│   ├── certs/              # SSL certificates (generated by certbot)
│   └── logs/               # Nginx access and error logs
└── certbot/
    └── www/                # ACME challenge files for Let's Encrypt
```

## Configuration

### Nginx Configuration

Edit `nginx/conf/default.conf` to customize your server blocks:

- **HTTP server (port 80)**: Handles ACME challenges and redirects to HTTPS
- **HTTPS server (port 443)**: Serves content with SSL encryption

### Environment Variables

Create a `.env` file for sensitive data:

```bash
DOMAIN=yourdomain.com
EMAIL=your-email@example.com
```

## SSL Certificate Management

### Automatic Renewal

Certbot runs as a background service and automatically renews certificates every 12 hours. No manual intervention required.

### Manual Certificate Operations

Generate new certificates:
```bash
docker compose run --rm certbot certonly --webroot -w /var/www/certbot -d yourdomain.com -d www.yourdomain.com
```

Force renewal (for testing):
```bash
docker exec certbot certbot renew --force-renewal
```

View certificate info:
```bash
docker exec certbot certbot certificates
```

Delete a certificate:
```bash
docker exec certbot certbot delete --cert-name yourdomain.com
```

## Troubleshooting

### Check service status
```bash
docker compose ps
```

### View logs
```bash
# All services
docker compose logs -f

# Specific service
docker compose logs -f web
docker compose logs -f certbot
```

### Test nginx configuration
```bash
docker exec nginx nginx -t
```

### Reload nginx after config changes
```bash
docker exec nginx nginx -s reload
```

### Common Issues

**Certificate not found**: Ensure you've generated initial certificates before starting nginx. The HTTPS server block expects certificates to exist.

**ACME challenge fails**: Verify your domain DNS points to this server and port 80 is accessible.

**Permission denied**: Check that the `certbot/www` directory is writable by the container.

## Security Notes

- SSL certificates are stored in `nginx/certs/` and excluded from version control
- TLS 1.2 and 1.3 are enabled with secure cipher suites
- HTTP Strict Transport Security (HSTS) can be added for enhanced security
- Regular security updates are applied via `nginx:latest` and `certbot/certbot:latest` images

## Updates

Update Docker images:
```bash
docker compose pull
docker compose up -d
```

## Configuration Example

Here's the default nginx configuration (`nginx/conf/default.conf`):

```nginx
server {
    listen 80;
    listen [::]:80;
    server_name mariomenjr.com *.mariomenjr.com;

    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    location / {
        return 301 https://$host$request_uri;
    }
}

server {
    listen 443 ssl;
    listen [::]:443 ssl;
    server_name mariomenjr.com *.mariomenjr.com;

    # SSL Certificate Paths
    ssl_certificate     /etc/nginx/certs/live/mariomenjr.com/fullchain.pem;
    ssl_certificate_key /etc/nginx/certs/live/mariomenjr.com/privkey.pem;

    # Security Headers
    ssl_protocols       TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;
    ssl_ciphers         HIGH:!aNULL:!MD5;

    location / {
        root   /usr/share/nginx/html;
        index  index.html index.htm;
    }

    error_page   500 502 503 504  /50x.html;
    location = /50x.html {
        root   /usr/share/nginx/html;
    }
}
```

Replace `mariomenjr.com` with your domain name in both server blocks and certificate paths.

## License

This project is licensed under the MIT License - see the [LICENSE](LICENSE) file for details.
